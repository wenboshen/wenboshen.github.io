---
title: "eBPF Implementation in Kernel"
collection: posts
permalink: /posts/2022-06-19-bpf
date: 2022-06-19
description: ""
category: 
tags: []
classes: wide
---
* TOC
{:toc}

## Unprivileged eBPF

eBPF allows unprivileged user to load eBPF program if `/proc/sys/kernel/unprivileged_bpf_disabled` is `0`.

The implementation is in [`__sys_bpf`](https://elixir.bootlin.com/linux/v6.3-rc1/source/kernel/bpf/syscall.c#L4944) in `linux/kernel/bpf/syscall.c`.

```
static int __sys_bpf(int cmd, bpfptr_t uattr, unsigned int size)
{
	union bpf_attr attr;
	bool capable;
	int err;

	capable = bpf_capable() || !sysctl_unprivileged_bpf_disabled;
    ...
}
```

## RO Hardening for JIT Code

The BPF JIT compiler sets the JITed native code to ROX (PXN clear). The call path is 
[`bpf_int_jit_compile`](https://elixir.bootlin.com/linux/v6.3-rc1/source/arch/arm64/net/bpf_jit_comp.c#L1453) -> [`bpf_jit_binary_lock_ro`](https://elixir.bootlin.com/linux/v6.3-rc1/source/arch/arm64/net/bpf_jit_comp.c#L1586) -> [`set_memory_rox`](https://elixir.bootlin.com/linux/v6.3-rc1/source/include/linux/set_memory.h#L18) -> [`change_memory_common`](https://elixir.bootlin.com/linux/v6.3-rc1/source/arch/arm64/mm/pageattr.c#L64)


`change_memory_common` will clear PXN bit, allowing native code execution in kernel mode.

## Where is eBPF byte code allocated?

## Where is JIT code allocated?

## How to isolate eBPF program?
